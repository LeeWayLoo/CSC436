"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
const fs_1 = require("fs");
const path_1 = require("path");
const ts = require("typescript");
const MagicString = require('magic-string');
exports.transformJavascript = (options) => {
    options.emitSourceMap = !!options.emitSourceMap;
    options.strict = !!options.strict;
    const { content, getTransforms, emitSourceMap, inputFilePath, outputFilePath, strict } = options;
    // Print error diagnostics.
    const checkDiagnostics = (diagnostics) => {
        if (diagnostics && diagnostics.length > 0) {
            let errors = '';
            errors = errors + '\n' + ts.formatDiagnostics(diagnostics, {
                getCurrentDirectory: () => ts.sys.getCurrentDirectory(),
                getNewLine: () => ts.sys.newLine,
                getCanonicalFileName: (f) => f,
            });
            return errors;
        }
    };
    // Make a in-memory host and populate it with a single file
    const fileMap = new Map();
    const sourcesMap = new Map();
    const outputs = new Map();
    // We're not actually writing anything to disk, but still need to define an outDir
    // because otherwise TS will fail to emit JS since it would overwrite the original.
    const tempOutDir = '$$_temp/';
    const tempFilename = 'bo-default-file.js';
    fileMap.set(tempFilename, content);
    // We need to load the default lib for noEmitOnError to work properly.
    const defaultLibFileName = 'lib.d.ts';
    const defaultLibContent = fs_1.readFileSync(path_1.join(path_1.dirname(require.resolve('typescript')), defaultLibFileName), 'UTF-8');
    fileMap.set(defaultLibFileName, defaultLibContent);
    fileMap.forEach((v, k) => sourcesMap.set(k, ts.createSourceFile(k, v, ts.ScriptTarget.ES2015)));
    const host = {
        getSourceFile: (fileName) => sourcesMap.get(fileName),
        getDefaultLibFileName: () => defaultLibFileName,
        getCurrentDirectory: () => '',
        getDirectories: () => [],
        getCanonicalFileName: (fileName) => fileName,
        useCaseSensitiveFileNames: () => true,
        getNewLine: () => '\n',
        fileExists: (fileName) => fileMap.has(fileName),
        readFile: (fileName) => fileMap.has(fileName) ? fileMap.get(fileName) : '',
        writeFile: (fileName, text) => outputs.set(fileName, text),
    };
    const tsOptions = {
        noEmitOnError: true,
        allowJs: true,
        // Using just line feed makes test comparisons easier, and doesn't matter for generated files.
        newLine: ts.NewLineKind.LineFeed,
        // We target next so that there is no downleveling.
        target: ts.ScriptTarget.ESNext,
        skipLibCheck: true,
        outDir: '$$_temp/',
        sourceMap: emitSourceMap,
        inlineSources: emitSourceMap,
        inlineSourceMap: false,
    };
    const program = ts.createProgram(Array.from(fileMap.keys()), tsOptions, host);
    // We need the checker inside transforms.
    const transforms = getTransforms.map((getTf) => getTf(program));
    const { emitSkipped, diagnostics } = program.emit(undefined, host.writeFile, undefined, undefined, { before: transforms, after: [] });
    let transformedContent = outputs.get(`${tempOutDir}${tempFilename}`);
    if (emitSkipped || !transformedContent) {
        // Throw only if we're in strict mode, otherwise return original content.
        if (strict) {
            throw new Error(`
        TS failed with the following error messages:

        ${checkDiagnostics(diagnostics)}
      `);
        }
        else {
            return {
                content,
                sourceMap: !emitSourceMap ? null : new MagicString(content).generateMap({
                    source: inputFilePath,
                    file: outputFilePath ? `${outputFilePath}.map` : null,
                    includeContent: true,
                }),
            };
        }
    }
    let sourceMap = null;
    if (emitSourceMap) {
        const tsSourceMap = outputs.get(`${tempOutDir}${tempFilename}.map`);
        const urlRegExp = /^\/\/# sourceMappingURL=[^\r\n]*/gm;
        sourceMap = JSON.parse(tsSourceMap);
        // Fix sourcemaps file references.
        if (outputFilePath) {
            sourceMap.file = path_1.basename(outputFilePath);
            transformedContent = transformedContent.replace(urlRegExp, `//# sourceMappingURL=${sourceMap.file}.map\n`);
            if (inputFilePath) {
                sourceMap.sources = [inputFilePath];
            }
            else {
                sourceMap.sources = [''];
            }
        }
        else {
            // TODO: figure out if we should inline sources here.
            transformedContent = transformedContent.replace(urlRegExp, '');
            sourceMap.file = '';
            sourceMap.sources = [''];
        }
    }
    return {
        content: transformedContent,
        sourceMap,
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtLWphdmFzY3JpcHQuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL2hhbnNsL1NvdXJjZXMvZGV2a2l0LyIsInNvdXJjZXMiOlsicGFja2FnZXMvYW5ndWxhcl9kZXZraXQvYnVpbGRfb3B0aW1pemVyL3NyYy9oZWxwZXJzL3RyYW5zZm9ybS1qYXZhc2NyaXB0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7OztHQU1HO0FBQ0gsMkJBQWtDO0FBQ2xDLCtCQUErQztBQUUvQyxpQ0FBaUM7QUFDakMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBWS9CLFFBQUEsbUJBQW1CLEdBQUcsQ0FBQyxPQUFtQztJQUNyRSxPQUFPLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDO0lBQ2hELE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7SUFDbEMsTUFBTSxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsYUFBYSxFQUFFLGFBQWEsRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDO0lBRWpHLDJCQUEyQjtJQUMzQixNQUFNLGdCQUFnQixHQUFHLENBQUMsV0FBNEI7UUFDcEQsRUFBRSxDQUFDLENBQUMsV0FBVyxJQUFJLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQyxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7WUFDaEIsTUFBTSxHQUFHLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsRUFBRTtnQkFDekQsbUJBQW1CLEVBQUUsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFO2dCQUN2RCxVQUFVLEVBQUUsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLE9BQU87Z0JBQ2hDLG9CQUFvQixFQUFFLENBQUMsQ0FBUyxLQUFLLENBQUM7YUFDdkMsQ0FBQyxDQUFDO1lBRUgsTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUNoQixDQUFDO0lBQ0gsQ0FBQyxDQUFDO0lBRUYsMkRBQTJEO0lBQzNELE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO0lBQzFDLE1BQU0sVUFBVSxHQUFHLElBQUksR0FBRyxFQUF5QixDQUFDO0lBQ3BELE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO0lBRTFDLGtGQUFrRjtJQUNsRixtRkFBbUY7SUFDbkYsTUFBTSxVQUFVLEdBQUcsVUFBVSxDQUFDO0lBQzlCLE1BQU0sWUFBWSxHQUFHLG9CQUFvQixDQUFDO0lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBRW5DLHNFQUFzRTtJQUN0RSxNQUFNLGtCQUFrQixHQUFHLFVBQVUsQ0FBQztJQUN0QyxNQUFNLGlCQUFpQixHQUFHLGlCQUFZLENBQUMsV0FBSSxDQUFDLGNBQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLEVBQ2hGLGtCQUFrQixDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDaEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0lBRW5ELE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLFVBQVUsQ0FBQyxHQUFHLENBQ3RDLENBQUMsRUFBRSxFQUFFLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUV6RCxNQUFNLElBQUksR0FBb0I7UUFDNUIsYUFBYSxFQUFFLENBQUMsUUFBUSxLQUFLLFVBQVUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFFO1FBQ3RELHFCQUFxQixFQUFFLE1BQU0sa0JBQWtCO1FBQy9DLG1CQUFtQixFQUFFLE1BQU0sRUFBRTtRQUM3QixjQUFjLEVBQUUsTUFBTSxFQUFFO1FBQ3hCLG9CQUFvQixFQUFFLENBQUMsUUFBUSxLQUFLLFFBQVE7UUFDNUMseUJBQXlCLEVBQUUsTUFBTSxJQUFJO1FBQ3JDLFVBQVUsRUFBRSxNQUFNLElBQUk7UUFDdEIsVUFBVSxFQUFFLENBQUMsUUFBUSxLQUFLLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQy9DLFFBQVEsRUFBRSxDQUFDLFFBQVEsS0FBSyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFFLEdBQUcsRUFBRTtRQUMzRSxTQUFTLEVBQUUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxLQUFLLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQztLQUMzRCxDQUFDO0lBRUYsTUFBTSxTQUFTLEdBQXVCO1FBQ3BDLGFBQWEsRUFBRSxJQUFJO1FBQ25CLE9BQU8sRUFBRSxJQUFJO1FBQ2IsOEZBQThGO1FBQzlGLE9BQU8sRUFBRSxFQUFFLENBQUMsV0FBVyxDQUFDLFFBQVE7UUFDaEMsbURBQW1EO1FBQ25ELE1BQU0sRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLE1BQU07UUFDOUIsWUFBWSxFQUFFLElBQUk7UUFDbEIsTUFBTSxFQUFFLFVBQVU7UUFDbEIsU0FBUyxFQUFFLGFBQWE7UUFDeEIsYUFBYSxFQUFFLGFBQWE7UUFDNUIsZUFBZSxFQUFFLEtBQUs7S0FDdkIsQ0FBQztJQUVGLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFOUUseUNBQXlDO0lBQ3pDLE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFFaEUsTUFBTSxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUMvQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUMvQyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFckMsSUFBSSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsVUFBVSxHQUFHLFlBQVksRUFBRSxDQUFDLENBQUM7SUFFckUsRUFBRSxDQUFDLENBQUMsV0FBVyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLHlFQUF5RTtRQUN6RSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQzs7O1VBR1osZ0JBQWdCLENBQUMsV0FBVyxDQUFDO09BQ2hDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQztnQkFDTCxPQUFPO2dCQUNQLFNBQVMsRUFBRSxDQUFDLGFBQWEsR0FBRyxJQUFJLEdBQUcsSUFBSSxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxDQUFDO29CQUN0RSxNQUFNLEVBQUUsYUFBYTtvQkFDckIsSUFBSSxFQUFFLGNBQWMsR0FBRyxHQUFHLGNBQWMsTUFBTSxHQUFHLElBQUk7b0JBQ3JELGNBQWMsRUFBRSxJQUFJO2lCQUNyQixDQUFDO2FBQ0gsQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0lBRUQsSUFBSSxTQUFTLEdBQXdCLElBQUksQ0FBQztJQUUxQyxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1FBQ2xCLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxVQUFVLEdBQUcsWUFBWSxNQUFNLENBQUMsQ0FBQztRQUNwRSxNQUFNLFNBQVMsR0FBRyxvQ0FBb0MsQ0FBQztRQUN2RCxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFxQixDQUFpQixDQUFDO1FBQzlELGtDQUFrQztRQUNsQyxFQUFFLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO1lBQ25CLFNBQVMsQ0FBQyxJQUFJLEdBQUcsZUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQzFDLGtCQUFrQixHQUFHLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQ3ZELHdCQUF3QixTQUFTLENBQUMsSUFBSSxRQUFRLENBQUMsQ0FBQztZQUNsRCxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO2dCQUNsQixTQUFTLENBQUMsT0FBTyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDdEMsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLFNBQVMsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMzQixDQUFDO1FBQ0gsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04scURBQXFEO1lBQ3JELGtCQUFrQixHQUFHLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDL0QsU0FBUyxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7WUFDcEIsU0FBUyxDQUFDLE9BQU8sR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNCLENBQUM7SUFDSCxDQUFDO0lBRUQsTUFBTSxDQUFDO1FBQ0wsT0FBTyxFQUFFLGtCQUFrQjtRQUMzQixTQUFTO0tBQ1YsQ0FBQztBQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGJhc2VuYW1lLCBkaXJuYW1lLCBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBSYXdTb3VyY2VNYXAgfSBmcm9tICdzb3VyY2UtbWFwJztcbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuY29uc3QgTWFnaWNTdHJpbmcgPSByZXF1aXJlKCdtYWdpYy1zdHJpbmcnKTtcblxuXG5leHBvcnQgaW50ZXJmYWNlIFRyYW5zZm9ybUphdmFzY3JpcHRPcHRpb25zIHtcbiAgY29udGVudDogc3RyaW5nO1xuICBpbnB1dEZpbGVQYXRoPzogc3RyaW5nO1xuICBvdXRwdXRGaWxlUGF0aD86IHN0cmluZztcbiAgZW1pdFNvdXJjZU1hcD86IGJvb2xlYW47XG4gIHN0cmljdD86IGJvb2xlYW47XG4gIGdldFRyYW5zZm9ybXM6IEFycmF5PChwcm9ncmFtOiB0cy5Qcm9ncmFtKSA9PiB0cy5UcmFuc2Zvcm1lckZhY3Rvcnk8dHMuU291cmNlRmlsZT4+O1xufVxuXG5leHBvcnQgY29uc3QgdHJhbnNmb3JtSmF2YXNjcmlwdCA9IChvcHRpb25zOiBUcmFuc2Zvcm1KYXZhc2NyaXB0T3B0aW9ucykgPT4ge1xuICBvcHRpb25zLmVtaXRTb3VyY2VNYXAgPSAhIW9wdGlvbnMuZW1pdFNvdXJjZU1hcDtcbiAgb3B0aW9ucy5zdHJpY3QgPSAhIW9wdGlvbnMuc3RyaWN0O1xuICBjb25zdCB7IGNvbnRlbnQsIGdldFRyYW5zZm9ybXMsIGVtaXRTb3VyY2VNYXAsIGlucHV0RmlsZVBhdGgsIG91dHB1dEZpbGVQYXRoLCBzdHJpY3QgfSA9IG9wdGlvbnM7XG5cbiAgLy8gUHJpbnQgZXJyb3IgZGlhZ25vc3RpY3MuXG4gIGNvbnN0IGNoZWNrRGlhZ25vc3RpY3MgPSAoZGlhZ25vc3RpY3M6IHRzLkRpYWdub3N0aWNbXSkgPT4ge1xuICAgIGlmIChkaWFnbm9zdGljcyAmJiBkaWFnbm9zdGljcy5sZW5ndGggPiAwKSB7XG4gICAgICBsZXQgZXJyb3JzID0gJyc7XG4gICAgICBlcnJvcnMgPSBlcnJvcnMgKyAnXFxuJyArIHRzLmZvcm1hdERpYWdub3N0aWNzKGRpYWdub3N0aWNzLCB7XG4gICAgICAgIGdldEN1cnJlbnREaXJlY3Rvcnk6ICgpID0+IHRzLnN5cy5nZXRDdXJyZW50RGlyZWN0b3J5KCksXG4gICAgICAgIGdldE5ld0xpbmU6ICgpID0+IHRzLnN5cy5uZXdMaW5lLFxuICAgICAgICBnZXRDYW5vbmljYWxGaWxlTmFtZTogKGY6IHN0cmluZykgPT4gZixcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gZXJyb3JzO1xuICAgIH1cbiAgfTtcblxuICAvLyBNYWtlIGEgaW4tbWVtb3J5IGhvc3QgYW5kIHBvcHVsYXRlIGl0IHdpdGggYSBzaW5nbGUgZmlsZVxuICBjb25zdCBmaWxlTWFwID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgY29uc3Qgc291cmNlc01hcCA9IG5ldyBNYXA8c3RyaW5nLCB0cy5Tb3VyY2VGaWxlPigpO1xuICBjb25zdCBvdXRwdXRzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcblxuICAvLyBXZSdyZSBub3QgYWN0dWFsbHkgd3JpdGluZyBhbnl0aGluZyB0byBkaXNrLCBidXQgc3RpbGwgbmVlZCB0byBkZWZpbmUgYW4gb3V0RGlyXG4gIC8vIGJlY2F1c2Ugb3RoZXJ3aXNlIFRTIHdpbGwgZmFpbCB0byBlbWl0IEpTIHNpbmNlIGl0IHdvdWxkIG92ZXJ3cml0ZSB0aGUgb3JpZ2luYWwuXG4gIGNvbnN0IHRlbXBPdXREaXIgPSAnJCRfdGVtcC8nO1xuICBjb25zdCB0ZW1wRmlsZW5hbWUgPSAnYm8tZGVmYXVsdC1maWxlLmpzJztcbiAgZmlsZU1hcC5zZXQodGVtcEZpbGVuYW1lLCBjb250ZW50KTtcblxuICAvLyBXZSBuZWVkIHRvIGxvYWQgdGhlIGRlZmF1bHQgbGliIGZvciBub0VtaXRPbkVycm9yIHRvIHdvcmsgcHJvcGVybHkuXG4gIGNvbnN0IGRlZmF1bHRMaWJGaWxlTmFtZSA9ICdsaWIuZC50cyc7XG4gIGNvbnN0IGRlZmF1bHRMaWJDb250ZW50ID0gcmVhZEZpbGVTeW5jKGpvaW4oZGlybmFtZShyZXF1aXJlLnJlc29sdmUoJ3R5cGVzY3JpcHQnKSksXG4gICAgZGVmYXVsdExpYkZpbGVOYW1lKSwgJ1VURi04Jyk7XG4gIGZpbGVNYXAuc2V0KGRlZmF1bHRMaWJGaWxlTmFtZSwgZGVmYXVsdExpYkNvbnRlbnQpO1xuXG4gIGZpbGVNYXAuZm9yRWFjaCgodiwgaykgPT4gc291cmNlc01hcC5zZXQoXG4gICAgaywgdHMuY3JlYXRlU291cmNlRmlsZShrLCB2LCB0cy5TY3JpcHRUYXJnZXQuRVMyMDE1KSkpO1xuXG4gIGNvbnN0IGhvc3Q6IHRzLkNvbXBpbGVySG9zdCA9IHtcbiAgICBnZXRTb3VyY2VGaWxlOiAoZmlsZU5hbWUpID0+IHNvdXJjZXNNYXAuZ2V0KGZpbGVOYW1lKSEsXG4gICAgZ2V0RGVmYXVsdExpYkZpbGVOYW1lOiAoKSA9PiBkZWZhdWx0TGliRmlsZU5hbWUsXG4gICAgZ2V0Q3VycmVudERpcmVjdG9yeTogKCkgPT4gJycsXG4gICAgZ2V0RGlyZWN0b3JpZXM6ICgpID0+IFtdLFxuICAgIGdldENhbm9uaWNhbEZpbGVOYW1lOiAoZmlsZU5hbWUpID0+IGZpbGVOYW1lLFxuICAgIHVzZUNhc2VTZW5zaXRpdmVGaWxlTmFtZXM6ICgpID0+IHRydWUsXG4gICAgZ2V0TmV3TGluZTogKCkgPT4gJ1xcbicsXG4gICAgZmlsZUV4aXN0czogKGZpbGVOYW1lKSA9PiBmaWxlTWFwLmhhcyhmaWxlTmFtZSksXG4gICAgcmVhZEZpbGU6IChmaWxlTmFtZSkgPT4gZmlsZU1hcC5oYXMoZmlsZU5hbWUpID8gZmlsZU1hcC5nZXQoZmlsZU5hbWUpISA6ICcnLFxuICAgIHdyaXRlRmlsZTogKGZpbGVOYW1lLCB0ZXh0KSA9PiBvdXRwdXRzLnNldChmaWxlTmFtZSwgdGV4dCksXG4gIH07XG5cbiAgY29uc3QgdHNPcHRpb25zOiB0cy5Db21waWxlck9wdGlvbnMgPSB7XG4gICAgbm9FbWl0T25FcnJvcjogdHJ1ZSxcbiAgICBhbGxvd0pzOiB0cnVlLFxuICAgIC8vIFVzaW5nIGp1c3QgbGluZSBmZWVkIG1ha2VzIHRlc3QgY29tcGFyaXNvbnMgZWFzaWVyLCBhbmQgZG9lc24ndCBtYXR0ZXIgZm9yIGdlbmVyYXRlZCBmaWxlcy5cbiAgICBuZXdMaW5lOiB0cy5OZXdMaW5lS2luZC5MaW5lRmVlZCxcbiAgICAvLyBXZSB0YXJnZXQgbmV4dCBzbyB0aGF0IHRoZXJlIGlzIG5vIGRvd25sZXZlbGluZy5cbiAgICB0YXJnZXQ6IHRzLlNjcmlwdFRhcmdldC5FU05leHQsXG4gICAgc2tpcExpYkNoZWNrOiB0cnVlLFxuICAgIG91dERpcjogJyQkX3RlbXAvJyxcbiAgICBzb3VyY2VNYXA6IGVtaXRTb3VyY2VNYXAsXG4gICAgaW5saW5lU291cmNlczogZW1pdFNvdXJjZU1hcCxcbiAgICBpbmxpbmVTb3VyY2VNYXA6IGZhbHNlLFxuICB9O1xuXG4gIGNvbnN0IHByb2dyYW0gPSB0cy5jcmVhdGVQcm9ncmFtKEFycmF5LmZyb20oZmlsZU1hcC5rZXlzKCkpLCB0c09wdGlvbnMsIGhvc3QpO1xuXG4gIC8vIFdlIG5lZWQgdGhlIGNoZWNrZXIgaW5zaWRlIHRyYW5zZm9ybXMuXG4gIGNvbnN0IHRyYW5zZm9ybXMgPSBnZXRUcmFuc2Zvcm1zLm1hcCgoZ2V0VGYpID0+IGdldFRmKHByb2dyYW0pKTtcblxuICBjb25zdCB7IGVtaXRTa2lwcGVkLCBkaWFnbm9zdGljcyB9ID0gcHJvZ3JhbS5lbWl0KFxuICAgIHVuZGVmaW5lZCwgaG9zdC53cml0ZUZpbGUsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLFxuICAgIHsgYmVmb3JlOiB0cmFuc2Zvcm1zLCBhZnRlcjogW10gfSk7XG5cbiAgbGV0IHRyYW5zZm9ybWVkQ29udGVudCA9IG91dHB1dHMuZ2V0KGAke3RlbXBPdXREaXJ9JHt0ZW1wRmlsZW5hbWV9YCk7XG5cbiAgaWYgKGVtaXRTa2lwcGVkIHx8ICF0cmFuc2Zvcm1lZENvbnRlbnQpIHtcbiAgICAvLyBUaHJvdyBvbmx5IGlmIHdlJ3JlIGluIHN0cmljdCBtb2RlLCBvdGhlcndpc2UgcmV0dXJuIG9yaWdpbmFsIGNvbnRlbnQuXG4gICAgaWYgKHN0cmljdCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBcbiAgICAgICAgVFMgZmFpbGVkIHdpdGggdGhlIGZvbGxvd2luZyBlcnJvciBtZXNzYWdlczpcblxuICAgICAgICAke2NoZWNrRGlhZ25vc3RpY3MoZGlhZ25vc3RpY3MpfVxuICAgICAgYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGNvbnRlbnQsXG4gICAgICAgIHNvdXJjZU1hcDogIWVtaXRTb3VyY2VNYXAgPyBudWxsIDogbmV3IE1hZ2ljU3RyaW5nKGNvbnRlbnQpLmdlbmVyYXRlTWFwKHtcbiAgICAgICAgICBzb3VyY2U6IGlucHV0RmlsZVBhdGgsXG4gICAgICAgICAgZmlsZTogb3V0cHV0RmlsZVBhdGggPyBgJHtvdXRwdXRGaWxlUGF0aH0ubWFwYCA6IG51bGwsXG4gICAgICAgICAgaW5jbHVkZUNvbnRlbnQ6IHRydWUsXG4gICAgICAgIH0pLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBsZXQgc291cmNlTWFwOiBSYXdTb3VyY2VNYXAgfCBudWxsID0gbnVsbDtcblxuICBpZiAoZW1pdFNvdXJjZU1hcCkge1xuICAgIGNvbnN0IHRzU291cmNlTWFwID0gb3V0cHV0cy5nZXQoYCR7dGVtcE91dERpcn0ke3RlbXBGaWxlbmFtZX0ubWFwYCk7XG4gICAgY29uc3QgdXJsUmVnRXhwID0gL15cXC9cXC8jIHNvdXJjZU1hcHBpbmdVUkw9W15cXHJcXG5dKi9nbTtcbiAgICBzb3VyY2VNYXAgPSBKU09OLnBhcnNlKHRzU291cmNlTWFwIGFzIHN0cmluZykgYXMgUmF3U291cmNlTWFwO1xuICAgIC8vIEZpeCBzb3VyY2VtYXBzIGZpbGUgcmVmZXJlbmNlcy5cbiAgICBpZiAob3V0cHV0RmlsZVBhdGgpIHtcbiAgICAgIHNvdXJjZU1hcC5maWxlID0gYmFzZW5hbWUob3V0cHV0RmlsZVBhdGgpO1xuICAgICAgdHJhbnNmb3JtZWRDb250ZW50ID0gdHJhbnNmb3JtZWRDb250ZW50LnJlcGxhY2UodXJsUmVnRXhwLFxuICAgICAgICBgLy8jIHNvdXJjZU1hcHBpbmdVUkw9JHtzb3VyY2VNYXAuZmlsZX0ubWFwXFxuYCk7XG4gICAgICBpZiAoaW5wdXRGaWxlUGF0aCkge1xuICAgICAgICBzb3VyY2VNYXAuc291cmNlcyA9IFtpbnB1dEZpbGVQYXRoXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNvdXJjZU1hcC5zb3VyY2VzID0gWycnXTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVE9ETzogZmlndXJlIG91dCBpZiB3ZSBzaG91bGQgaW5saW5lIHNvdXJjZXMgaGVyZS5cbiAgICAgIHRyYW5zZm9ybWVkQ29udGVudCA9IHRyYW5zZm9ybWVkQ29udGVudC5yZXBsYWNlKHVybFJlZ0V4cCwgJycpO1xuICAgICAgc291cmNlTWFwLmZpbGUgPSAnJztcbiAgICAgIHNvdXJjZU1hcC5zb3VyY2VzID0gWycnXTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGNvbnRlbnQ6IHRyYW5zZm9ybWVkQ29udGVudCxcbiAgICBzb3VyY2VNYXAsXG4gIH07XG59O1xuIl19